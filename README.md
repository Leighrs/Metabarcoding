# Metabarcoding Directory Setup & Pipeline

![GitHub Repo Size](https://img.shields.io/github/repo-size/Leighrs/Metabarcoding)
![License](https://img.shields.io/github/license/Leighrs/Metabarcoding)
![Last Commit](https://img.shields.io/github/last-commit/Leighrs/Metabarcoding)

Welcome to the **Metabarcoding** repository for the **Genomic Variation Laboratory**!  
This repository helps lab members quickly set up a standardized directory structure on the HPC for running metabarcoding analyses using the **nf-core/ampliseq pipeline**.

---
## Table of Contents

- [Repository Overview](#repository-overview)
- [Current Files](#current-files)
- [Getting Started](#getting-started)
  - [1. Clone the Repository](#1-clone-the-repository)
  - [2. Set Up Your Project Directory on-hpc](#2-set-up-your-project-directory-on-hpc)
  - [3. Update the NCBI Database (Optional)](#3-update-the-ncbi-database-optional)
- [Running Pipeline](#running-pipeline)
  - [4. Run the nf-coreampliseq Pipeline](#4-run-the-nf-coreampliseq-pipeline)
  - [5. BLAST Unknown ASVs (Optional)](#5-blast-unknown-asvs-optional)
  - [6. Decontaminate ASVs and apply read thresholds (Optional)](#6-decontaminate-asvs-and-apply-read-thresholds)

## Repository Overview

This repository contains scripts and configuration files to:

1. Set up your project directory on the HPC.
2. Provide example files (samplesheets, metadata, and RSD sequences) for testing and reference.
3. Run the nf-core/ampliseq pipeline on your data.
4. Perform BLAST searches for unknown ASVs.
5. Update and download the NCBI core nucleotide database.
6. Clean and process ASV tables using downstream R scripts.

### Current Files

| File | Description |
|------|-------------|
| `nf-params.json` | Parameter file for the nf-core/ampliseq pipeline. Customize for your project. |
| `setup_metabarcoding_directory.sh` | Shell script to create your project directory with example samplesheets, metadata, and RSD files. |
| `update_blast_db.slurm` | SLURM batch script to download/update the NCBI core nucleotide database. |
| `blast_asv.slurm` | SLURM batch script to BLAST unknown ASVs. |
| `run_ampliseq.slurm` | SLURM batch script to execute the nf-core/ampliseq pipeline. |
| `R_ASV_cleanup_scripts/` | Folder containing R scripts for cleaning and formatting ASV tables after nf-core/ampliseq and optional BLAST. |

> More scripts will be added over time to streamline additional steps.

---

## Getting Started

### 1. Clone the Repository

```bash
git clone https://github.com/Leighrs/Metabarcoding.git
cd Metabarcoding
```
### 2. Set Up Your Project Directory on HPC
```bash
bash setup_metabarcoding_directory.sh
```
- Your project directory structure will look like:
```bash
Metabarcoding/
└── <project_name>/
    ├── input/
    │   ├── fastq/
    │   ├── Example_samplesheet.txt
    │   ├── Example_metadata.txt
    │   └── Example_RSD.txt
    └── output/
        └── intermediates_logs_cache/
            └── singularity/
```
### 3. Update the NCBI Database (Optional)
```bash
sbatch update_blast_db.slurm
```
## Running pipeline
### 4. Run the nf-core/ampliseq Pipeline
```bash
sbatch run_ampliseq.slurm
```
### 5. BLAST Unknown ASVs (Optional)
```bash
sbatch blast_asv.slurm
```
### 6. Decontaminate ASVs and apply read thresholds
- The folder `R_ASV_cleanup_scripts/` contains a collection of R scripts used for cleaning ASV data generated by the nf-core/ampliseq pipeline to prepare finalized datasets for analyses.
#### Available scripts include:
| Script | Description |
|------|-------------|
| `GVL_metabarcoding_cleanup_main.R` | Master script to run all ASV cleanup steps below |
| `1_Data_Analyses_decontam_removal_251106.R` | Removes reads found in control samples from samples assigned to those controls. |
| `2_Data_Analyses_presence_absence_after_decontam_removal_251106.R` | Produces a presence/absence matrix after decontamination removal. |
| `3_Data_Analyses_sample_threshold_251106.R` | Applies an optional per-sample ASV abundance threshold. |
| `4_Data_Analyses_presence_absence_after_sample_threshold_251106.R` | Produces a presence/absence matrix after per-sample ASV abundance threshold. |
| `5_Data_Analyses_total_threshold_251106.R` | Applies a minimum sequencing depth threshold across all samples. |
| `6_Data_Analyses_presence_absence_after_total_threshold_251106.R` | Produces a final presence/absence matrix after minimum sequencing depth threshold. |

- These scripts are optional but extremely helpful for producing clean, analysis ready ASV tables.
- You should only need to enter the `GVL_metabarcoding_cleanup_main.R` script to run this pipeline. To avoid breaking the script, only edit the **"User-defined parameters"** in the script.
